@SET_MAKE@

FC = @FC@
#FCFLAGS = @FCFLAGS@ @NETFFLAGS@
FCFLAGS = @NETFFLAGS@
FCFLAGS_f90 = @FCFLAGS_f90@
FC_MODEXT = @FC_MODEXT@
FC_MODINC = @FC_MODINC@
FC_MODOUT = @FC_MODOUT@
CPPFLAGS = @CPPFLAGS@

OPENMP_FCFLAGS = @OPENMP_FCFLAGS@

SED = @SED@

LDFLAGS = @LDFLAGS@
LIBOBJS = @LIBOBJS@
LIBS = @LIBS@

SET_MAKE = @SET_MAKE@

EXEEXT = @EXEEXT@

SHELL:=/bin/bash

prefix = $(CURDIR)/
bindir = $(prefix)bin/
builddir = $(prefix)build/
docdir = $(prefix)doc/
includedir = $(prefix)include/
srcdir = $(prefix)src/
selfcheck_dir = $(prefix)selfcheck/

include_modelHeader = $(includedir)

UDDIR = @UDDIR@
NETDIR = @NETDIR@
CUDADIR = @CUDADIR@

bin_PROGRAMS = model$(EXEEXT)
model_SOURCES = calc_lib.f90 calendar_module.f90 diag_module.f90 dynFromFile_module.f90 ElSolv_SOR.f90 io_module.f90 memchunk_module.f90 model.f90 swm_damping_module.f90 swm_forcing_module.f90 swm_lateralmixing_module.f90 swm_module.f90 swm_timestep_module.f90 tracer_module.f90 vars_module.f90 domain_module.f90 grid_module.f90

O := -O3 $(OPENMP_FCFLAGS)
DEBUG = #-Wall #-g
FFLAGS = $(FCFLAGS) $(FCFLAGS_f90) $(defSelfCheck) $(DEBUG) $(O)
#libnc = -L$(NETDIR)/lib -lnetcdff
libnc = @NETFLIBS@
#includenc = $(FC_MODINC)$(NETDIR)/include
includenc = $(FC_MODINC)@NETINCL@
libud = -L$(UDDIR)/lib -ludunits2 -lexpat
#include_dir = -Iinclude
#include_h = -Iinclude -Ibuild
#build_dir = build/
DOXYGEN = @DOXYGEN@

COMPILE = $(FC) $(FFLAGS) $(CPPFLAGS) $(includenc) $(FC_MODINC)$(builddir) $(include_selfcheck) $(FC_MODINC)$(includedir) -c $< $(FC_MODOUT)$(builddir) -o$(builddir)$@
VPATH = include:src:build:bin

# conditional modules
#cl_elsolv := ElSolv_SOR # comment this line out if you don't want to use an elliptic solver in the calc_lib module
ifneq ($(strip $(cl_elsolv)),)
  $(info Elliptic solver used by calc_lib module: $(strip $(cl_elsolv)))
  cl_elsolv.o := $(cl_elsolv:%=%.o)
  defClElSolv := $(cl_elsolv:%=-D'CALC_LIB_ELLIPTIC_SOLVER=%')
  defClElSolv += $(cl_elsolv:%=-D'CALC_LIB_ELLIPTIC_SOLVER_HEADER="%.h"')
else
  $(info Elliptic solver used by calc_lib module: none)
endif

# don't use CUDA if directory is not specified
ifneq ($(strip $(CUDADIR)),)
  cl_cuda := cuda_memory cuda_c_module cuda_kernels cuda_module
  cl_cuda_o := $(cl_cuda:%=%.o)
  cl_nvcc := nvcc
  cl_cuff := -arch='sm_21'
  libcu := -L$(CUDADIR)/lib64 -lcudart
  cl_defCudaEnabled = -D'CUDA_ENABLED'
  CUCOMPILE = $(cl_nvcc) $(cl_cuff) $(FC_MODINC)$(includedir) -c $< -o $(builddir)$@
endif

modules = str vars_module calendar_module diag_module swm_module tracer_module io_module calc_lib dynFromFile_module $(cl_elsolv) memchunk_module swm_vars swm_forcing_module swm_timestep_module swm_damping_module swm_lateralmixing_module generic_list diagTask diagVar domain_module grid_module $(cl_cuda)
objects = $(modules:%=$(builddir)%.o)


.PHONY: all clean clean-selfcheck clean-doc selfcheck doc distclean clean-conf

all     : $(bin_PROGRAMS)
#clean

model$(EXEEXT)   : $(modules:%=%.o) model.o
	$(FC) $(FFLAGS) -o$(bindir)$@ $(objects) $(builddir)model.o $(LDFLAGS) $(libnc) $(libud) $(libcu)

model.o : model.f90 io_module.o vars_module.o domain_module.o calc_lib.o diag_module.o dynFromFile_module.o swm_module.o tracer_module.o model.h io.h $(cl_cuda_o)
	$(COMPILE)

vars_module.o : vars_module.f90 generic_list.o domain_module.o str.o io.h
	$(COMPILE)

calendar_module.o : calendar_module.f90 fudunits2.h io.h
	$(COMPILE)

swm_module.o : swm_module.f90 vars_module.o io_module.o swm_vars.o swm_forcing_module.o swm_timestep_module.o swm_damping_module.o domain_module.o
	$(COMPILE)

diag_module.o : diag_module.f90 vars_module.o diagTask.o model.h
	$(COMPILE)

diagTask.o : diagTask.f90 io.h io_module.o vars_module.o domain_module.o diagVar.o generic_list.o str.o
	$(COMPILE)

diagVar.o : diagVar.f90 vars_module.o io.h domain_module.o calc_lib.o generic_list.o
	$(COMPILE)

io_module.o : io_module.f90 io.h calendar_module.o grid_module.o str.o
	$(COMPILE)

ElSolv_SOR.o : ElSolv_SOR.f90 ElSolv_SOR.h vars_module.o domain_module.o model.h
	$(COMPILE)

tracer_module.o : tracer_module.f90 tracer_module.h vars_module.o io_module.o calc_lib.o domain_module.o model.h
	$(COMPILE)

calc_lib.o : calc_lib.f90 calc_lib.h vars_module.o domain_module.o model.h $(cl_elsolv.o)
	$(FC) $(FFLAGS) $(defClElSolv) $(FC_MODINC)$(builddir) $(include_selfcheck) $(FC_MODINC)$(includedir) -c $< $(FC_MODOUT)$(builddir) -o$(builddir)$@

dynFromFile_module.o : dynFromFile_module.f90 vars_module.o calc_lib.o memchunk_module.o domain_module.o
	$(COMPILE)

memchunk_module.o : memchunk_module.f90 io_module.o calc_lib.o domain_module.o
	$(COMPILE)

swm_vars.o : swm_vars.f90 vars_module.o domain_module.o memchunk_module.o
	$(COMPILE)

swm_forcing_module.o : swm_forcing_module.f90 model.h swm_module.h io.h vars_module.o memchunk_module.o domain_module.o generic_list.o
	$(COMPILE)

swm_timestep_module.o : swm_timestep_module.f90 model.h swm_module.h io.h swm_vars.o swm_damping_module.o swm_forcing_module.o swm_lateralmixing_module.o vars_module.o memchunk_module.o calc_lib.o domain_module.o grid_module.o
	$(COMPILE)

swm_damping_module.o : swm_damping_module.f90 model.h swm_module.h swm_vars.o vars_module.o domain_module.o memchunk_module.o str.o
	$(COMPILE)

swm_lateralmixing_module.o : swm_lateralmixing_module.f90 model.h vars_module.o swm_vars.o domain_module.o grid_module.o calc_lib.o
	$(COMPILE)

domain_module.o : domain_module.f90 grid_module.o io_module.o io.h
	$(COMPILE)

grid_module.o : grid_module.f90 model.h
	$(COMPILE)

cuda_memory.o : cuda_memory.cu cuda_memory.h
	$(CUCOMPILE)

cuda_kernels.o : cuda_kernels.cu cuda_module.h cuda_memory.h cuda_kernels.h
	$(CUCOMPILE)

cuda_c_module.o : cuda_module.cu cuda_module.h cuda_memory.h cuda_kernels.h
	$(CUCOMPILE)

cuda_module.o : cuda_module.f90 cuda_c_module.o swm_vars.o domain_module.o vars_module.o swm_timestep_module.o swm_damping_module.o swm_forcing_module.o
	$(COMPILE)

%.o : %.f90
	$(COMPILE)

include $(selfcheck_dir)Makefile

doc : doc/Doxyfile doc/html doc/latex
	@cd $(docdir) && $(DOXYGEN) $(<F)
	@cd $(docdir)/latex && $(MAKE)


# create folder if needed

include/  :
	mkdir -p $@

doc/html :
	mkdir -p $@

doc/latex :
	mkdir -p $@

distclean : clean clean-doc clean-conf clean-selfcheck

clean-conf:
	@rm -fv config.status
	@rm -fv config.log
	@rm -fv Makefile

clean :
	@rm -fv $(builddir)*
	@rm -fv $(bindir)*

clean-doc :
	@rm -rvf $(docdir)latex $(docdir)html $(docdir)doxygen_objdb_*

clean-selfcheck :
	@rm -rf $(selfcheck_dir)*/output/new_*
	@rm -rf $(selfcheck_dir)utest_str/utest_str
