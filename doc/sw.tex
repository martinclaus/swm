\documentclass[a4paper]{article}

%=======================================================================

\usepackage[authoryear, round]{natbib}
\usepackage{url}
\usepackage[intlimits]{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{epstopdf}

%=======================================================================

\include{command}

%=======================================================================

\title{Shallow water model}
\author{Martin Claus, Willi Rath}
\date{\today}

%=======================================================================

\begin{document}

\maketitle

%=======================================================================

\section{Equations}
\subsection{Basic Equations}
In Cartesian coordinates, the system is described by
\begin{align}
  \label{eq:basic_u}
  & u_t - fv = -g \eta_x + F_u \\
  \label{eq:basic_v}
  & v_t + fu = -g \eta_y + F_v \\
  \label{eq:basic_eta}
  & \eta_t + (Hu)_x + (Hv)_y = F_\eta
\end{align}
Spherical coordinates with $a$ being the radius of the earth, $\lambda$ the 
longitude, and $\vartheta$ the latitude:
\begin{align}
  & u_t - fv = -g \frac{1}{a\cos\vartheta}\pder{\eta}{\lambda} + F_u \\
  & v_t + fu = -g \frac{1}{a}\pder{\eta}{\vartheta} + F_v \\
  & \eta_t + \frac{1}{a\cos\vartheta}\pder{Hu}{\lambda} + \frac{1}{a\cos\vartheta}\pder{\cos\vartheta Hv}{\vartheta} = F_\eta
\end{align}
\subsection{Forcing and Damping}
The forcing and damping terms $F_u$ in (\ref{eq:basic_u}) and $F_v$ in (\ref{eq:basic_v}) represent one or the sum of some of the following terms.

\subsubsection{Bottom Friction Term}
The model can use both linear and quadratic bottom friction.
The linear friction term is described by
\begin{equation}
 \pder{(u,v)}{t} = X -\frac rH (u,v)
\end{equation}
The discretized form following an implicit scheme is
\begin{equation}
  \dthree{u}uij{l+1} = \frac{\dthree{u}uijl + X_u}{1+\frac{\Delta t r}{\dtwo{H}uij}}
\end{equation}
\begin{equation}
  \dthree{v}vij{l+1} = \frac{\dthree{v}vijl + X_v}{1+\frac{\Delta t r}{\dtwo{H}vij}}
\end{equation}
where r is the linear bottom friction coefficient and $X_u$ and $X_v$ represents the residual terms of the momentum equation. We use an implicit scheme
to gain unconditional numerical stability of the linear friction term.

The quadratic friction term is described by
\begin{equation}
  F = -\frac kH \sqrt{u^2+v^2}\,(u,v)
\end{equation}
Discretization using an explicit scheme leads to
\begin{equation}
  \dtwo{F_u}uij = -\frac k{H\vert^{ij}_u} \sqrt{(u\vert^{ijl}_u)^2+\left(\frac{v\vert^{i,j+1,l}_v+v\vert^{ijl}_v+v\vert^{i-1,j+1,l}_v+v\vert^{i-1,j,l}_v}4\right)^2}u\vert^{ijl}_u
\end{equation}
\begin{equation}
  \dtwo{F_v}vij = -\frac k{H\vert^{ij}_v} \sqrt{\left(\frac{u\vert^{i+1,j,l+1}_u+u\vert^{i+1,j-1,l+1}_u+u\vert^{i,j,l+1}_u+u\vert^{i,j-1,l+1}_u}4\right)^2+(v\vert^{ijl}_v)^2}v\vert^{ijl}_v
\end{equation}
where k is the empirical quadratic bottom friction coefficient.

\subsubsection{Lateral Mixing of Momentum}
The lateral mixing of momentum is described by
\begin{equation}
  F_u=A_hf^\lambda
\end{equation}
\begin{equation}
  F_v=A_hf^\vartheta
\end{equation}
where $A_h$ is the horizontal eddy viscosity. Following Bryan (1969) the lateral mixing of momentum is
parameterized in spherical coordinates with consideration of conservation of momentum by
\begin{equation}\begin{split}
  f^\lambda=&\frac1{a^2\cos^2\vartheta
    H}\pdertwo{uH}{\lambda}+\frac1{a^2\cos\vartheta H}\pder{}{\vartheta}\left(\cos\vartheta\pder{uH}{\vartheta}\right)\\
  &+\frac1{a^2H}\left((1-\tan^2\vartheta)uH-\frac{2\tan\vartheta}{\cos\vartheta}\pder{vH}{\lambda}\right)
\end{split}\end{equation}
\begin{equation}\begin{split}
  f^\vartheta=&\frac1{a^2\cos^2\vartheta
    H}\pdertwo{vH}{\lambda}+\frac1{a^2\cos\vartheta H}\pder{}{\vartheta}\left(\cos\vartheta\pder{vH}{\vartheta}\right)\\
  &+\frac1{a^2H}\left((1-\tan^2\vartheta)vH-\frac{2\tan\vartheta}{\cos\vartheta}\pder{uH}{\lambda}\right)
\end{split}\end{equation}
Discretization and consideration of the free-slip boundary condition (see \ref{subs:free-slip}) leads to
\begin{equation}
  \begin{split}
    \dthree{f^\lambda}uijl =&
    \frac1{\Delta\lambda^2 a^2\done{\cos^2\vartheta}uj\dtwo{H}uij}(\dthree{u}u{i+1}jl\dtwo{H}u{i+1}j-2\dthree{u}uijl\dtwo{H}uij+\dthree{u}u{i-1}jl\dtwo{H}u{i-1}j)\\
    &-\frac{\done{\tan\vartheta}uj}{2\Delta\vartheta a^2\dtwo{H}uij}(\dthree{u}ui{j+1}l\dtwo{H}ui{j+1}\mathfrak{o}^{i,j+1}-\dthree{u}ui{j-1}l\dtwo{H}ui{j-1}\mathfrak{o}^{i,j}-(\mathfrak{o}^{i,j+1}-\mathfrak{o}^{i,j})\dthree{u}{u}{i}{j}{l}\dtwo{H}{u}{i}{j})\\
    &+\frac1{\Delta\vartheta^2 a^2\dtwo{H}uij}(\dthree{u}ui{j+1}l\dtwo{H}ui{j+1}\mathfrak{o}^{i,j+1}-(\mathfrak{o}^{i,j+1}+\mathfrak{o}^{i,j})\dthree{u}uijl\dtwo{H}uij+\dthree{u}ui{j-1}l\dtwo{H}ui{j-1}\mathfrak{o}^{i,j})\\
    &+\frac{1-\done{\tan^2\vartheta}uj}{a^2\dtwo{H}uij}\dthree{u}uijl\dtwo{H}uij\\
    &-\frac{\done{\tan\vartheta}uj}{a^2\done{\cos\vartheta}uj\Delta\lambda\dtwo{H}uij}\left(\dthree{v}vi{j+1}l\dtwo{H}vi{j+1}\mathfrak{o}^{i,j+1}+\dthree{v}vijl\dtwo{H}vij\mathfrak{o}^{i,j}\right)\\
    &+\frac{\done{\tan\vartheta}uj}{a^2\done{\cos\vartheta}uj\Delta\lambda\dtwo{H}uij}\left(\dthree{v}v{i-1}{j+1}l\dtwo{H}v{i-1}{j+1}\mathfrak{o}^{i,j+1}+\dthree{v}v{i-1}jl\dtwo{H}v{i-1}j\mathfrak{o}^{i,j}\right)
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \dthree{f^\vartheta}vijl =&
    \frac1{\Delta\lambda^2 a^2\done{\cos^2\vartheta}vj\dtwo{H}vij}(\dthree{v}v{i+1}jl\dtwo{H}v{i+1}j\mathfrak{o}^{i+1,j}-(\mathfrak{o}^{i+1,j}+\mathfrak{o}^{i,j})\dthree{v}vijl\dtwo{H}vij+\dthree{v}v{i-1}jl\dtwo{H}v{i-1}j\mathfrak{o}^{i,j})\\
    &-\frac{\done{\tan\vartheta}vj}{2\Delta\vartheta a^2\dtwo{H}vij}(\dthree{v}vi{j+1}l\dtwo{H}vi{j+1}-\dthree{v}vi{j-1}l\dtwo{H}vi{j-1})\\
    &+\frac1{\Delta\vartheta^2 a^2\dtwo{H}vij}(\dthree{v}vi{j+1}l\dtwo{H}vi{j+1}-2\dthree{v}vijl\dtwo{H}vij+\dthree{v}vi{j-1}l\dtwo{H}vi{j-1})\\
    &+\frac{1-\done{\tan^2\vartheta}vj}{a^2\dtwo{H}vij}\dthree{v}vijl\dtwo{H}vij\\
    &-\frac{\done{\tan\vartheta}vj}{a^2\done{\cos\vartheta}vj\Delta\lambda\dtwo{H}vij}\left(\dthree{u}u{i+1}jl\dtwo{H}u{i+1}j+\dthree{u}u{i+1}{j-1}l\dtwo{H}u{i+1}{j-1}\right)\\
    &+\frac{\done{\tan\vartheta}vj}{a^2\done{\cos\vartheta}vj\Delta\lambda\dtwo{H}vij}\left(\dthree{u}uijl\dtwo{H}uij+\dthree{u}ui{j-1}l\dtwo{H}ui{j-1}\right)
  \end{split}
\end{equation}
where $\mathfrak{o}$ is the ocean mask defined on the H-grid.
\begin{equation}
  \mathfrak{o}^{i,j} = \left\{ \begin{array}{rcl} 0 & \mbox{if} & \dtwo{H}{H}{i}{j}=0 \\
				1 & \mbox{else} & \end{array} \right.
\end{equation}
Note that $\done{u}ul$ is used in the v-equation instead of $\done{u}u{l+1}$.

\subsubsection{Surface Stress Forcing}
Wind stress $\tau_s$ can be used to force the model. The forcing term in the u- and v-equation can be written as
\begin{align}
  F_u &= \frac{\tau_s^\lambda}{\rho_0H} \\
  F_v &= \frac{\tau_s^\vartheta}{\rho_0H}
\end{align}
where $\tau_s^\lambda$ is the zonal and $\tau_s^\vartheta$ the meridional component of the wind stress. Since both components are provided on different grids, the zonal on the u-grid, the meridional on the v-grid, discretization yields\footnote{There is an implicit two-point averaging of H to the u- and v-grid}
\begin{align}
  \dtwo{F_u}uij &= \frac{\dtwo{\tau_s^\lambda}uij}{\rho_0\dtwo{H}uij} \\
  \dtwo{F_v}vij &= \frac{\dtwo{\tau_s^\vartheta}vij}{\rho_0\dtwo{H}vij}
\end{align}

\subsubsection{Reynolds Stress Forcing}
Reynolds stresses derived from observations can be used to force the
model. These stresses are known at the surface and are supposed to decrease
linearly with depth to zero. So the forcing terms in the u- and v-equation can
be written as
\begin{equation}
  \begin{split}
    F_u&=-\frac1H\int_{-H}^0\pder{}{x}\left[\rey{u}{u}\left(\frac{z+H}H\right)\right]\dd
    z -
    \frac1H\int_{-H}^0\pder{}{y}\left[\rey{u}{v}\left(\frac{z+H}H\right)\right]\dd
    z\\
    &=-\frac1{2Ha\cos\vartheta}\pder{}{\lambda}\left(\rey{u}{u}H\right)-\frac1{2Ha\cos\vartheta}\pder{}{\vartheta}\left(\cos\vartheta\rey{u}{v}H\right)
  \end{split}
\end{equation}
And analog
\begin{equation}
  \begin{split}
    F_v&=-\frac1{2Ha\cos\vartheta}\pder{}{\lambda}\left(\rey{u}{v}H\right)-\frac1{2Ha\cos\vartheta}\pder{}{\vartheta}\left(\cos\vartheta\rey{v}{v}H\right)
  \end{split}
\end{equation}
Discretization\footnote{There is an implicit four point
  averaging from the H-grid to the $\eta$-grid since all stress terms and topography are
  provided on the H-grid} leads to
\begin{equation}
  \begin{split}
    \dtwo{F_u}uij=&-\frac1{2\dtwo{H}uija\done{\cos\vartheta}uj}\left(\frac{\dtwo{\rey{u}{u}}{\eta}ij\dtwo{H}{\eta}ij-\dtwo{\rey{u}{u}}{\eta}{i-1}j\dtwo{H}{\eta}{i-1}j}{\Delta\lambda}\right.\\
&\left.-\frac{\done{\cos\vartheta}H{j+1}\dtwo{\rey{u}{v}}Hi{j+1}\dtwo{H}Hi{j+1}-\done{\cos\vartheta}Hj\dtwo{\rey{u}{v}}Hij\dtwo{H}Hij)}{\Delta\vartheta}\right)
  \end{split}
\end{equation}
\begin{equation}
  \begin{split}
    \dtwo{F_v}vij=&-\frac1{2\dtwo{H}vija\done{\cos\vartheta}vj}\left(\frac{\done{\cos\vartheta}{\eta}j\dtwo{\rey{v}{v}}{\eta}ij\dtwo{H}{\eta}ij-\done{\cos\vartheta}{\eta}{j-1}\dtwo{\rey{v}{v}}{\eta}i{j-1}\dtwo{H}{\eta}i{j-1}}{\Delta\vartheta}\right.\\
&\left.-\frac{\dtwo{\rey{u}{v}}H{i+1}j\dtwo{H}H{i+1}j-\dtwo{\rey{u}{v}}Hij\dtwo{H}Hij)}{\Delta\lambda}\right)
  \end{split}
\end{equation}

\subsubsection{Newtonian Cooling}
If the setup is a $1\frac12$-Layer baroclinic model, diapycnal mixing at the interface is parameterized by a Newtonian cooling term which is described by
\begin{equation}
	\pder{\eta}{t} = X-\gamma\eta
\end{equation}
Discretization using a implicit scheme leads to
\begin{equation}
	\dthree{\eta}\eta{i}{j}{l+1} = \frac{X_\eta + \dthree{\eta}{\eta}{i}{j}{l}}{1+\Delta t\gamma}
\end{equation}
where $X$ represents the residual terms of the continuity equation (i.e. the horizontal mass flux divergence)
%=======================================================================

\section{Grid}
We want the grid to be as natural as possible (i.e., no averaging in the 
$\eta$-gradients and in the continuity equation):
\begin{figure}[h]
  \begin{center}
    \includegraphics[width=0.35\textwidth]{images/grid}
  \end{center}
  \caption{Grid arrangement. We use an Arakawa C-grid with the topography
    on the free grid points.  }
\end{figure}
The fields will all carry integer indices which are to be interpreted according to
\begin{align}
  H|_H^{ij} & = H(\Delta x \cdot i, \Delta y \cdot j) \\
  \eta|_\eta^{ijl} & = \eta(\Delta x \cdot (i+1/2), \Delta y \cdot (j+1/2), \Delta t \cdot l) \\
  u|_u^{ijl} & = u(\Delta x \cdot i, \Delta y \cdot (j+1/2), \Delta t \cdot l) \\
  v|_v^{ijl} & = v(\Delta x \cdot (i+1/2), \Delta y \cdot j, \Delta t \cdot l)
\end{align}
An expression like $H|_u^{ij}$ means that the depth is interpolated to the $u$-grid
by simple linear interpolation which is two-point averaging here. In the Coriolis term, 
we'll need four point averaging from the $v$-grid to the $u$-grid and from the $u$-grid
to the $v$-grid. The $x$- and $y$-derivatives in the continuity equation will all need 
two point averaging from the $H$-grid to the $u$- and $v$-grid.

%=======================================================================

\section{Boundary conditions}

%-----------------------------------------------------------------------

\subsection{Coastlines / Land mask}
We'll define land to be where $H$ is zero. This implies that $u$- and $v$-grid
points are over land if both the closest $H$-grid points are over land.
$\eta$-grid points are over land, if all four surrounding $H$-grid points are over land.
It will probably be computationally effective to define masks for all three dynamic variables.

%-----------------------------------------------------------------------

\subsection{Periodic boundary conditions}
For a global model, we'll need to implement periodic boundary conditions in the zonal
direction.  In the meridional direction we might get away without as we won't be able 
to extend the model domain to the poles anyway (CFL will become a problem there).

\subsection{Free-slip Boundary condition}
\label{subs:free-slip}
The model fulfill the free-slip boundary conditions which are $u=0$ and $v=0$ if the 
corresponding u- and v-grid points are over land, and $(uH)_y=0$ and $(vH)_x=0$ if the derivative is measured
across a boundary, i.e. the H grid point in between the two u- or v-grid points is land. Please note that
second boundary condition only influences the lateral mixing terms.

%=======================================================================

\section{Time stepping scheme}
Use Heaps (1972) which basically amounts to\footnote{Note that the superscript
of $v$ in the second equation is mean to be an $l$ while all the others are meant
to be $l+1$. In each line, you use the newest information that is available ...}
\begin{align}
  \eta^{l+1} & = \eta^l - \Delta t (Hu^l)_x - \Delta t (Hv^l)_y + \Delta t F_\eta\\
  u^{l+1} & = u^l + \Delta t f v^l - \Delta t g \eta^{l+1}_x + \Delta t F_u\\
  v^{l+1} & = v^l - \Delta t f u^{l+1} - \Delta t g \eta^{l+1}_y + \Delta t F_v
\end{align}
Spherical coordinates with full\footnote{There still is an implicit two point
averaging from the $H$-grid to the $u$- and $v$-grids as well as an implicit
four point averaging in the Coriolis term.} glory:
\begin{equation}
  \begin{split}
    \eta|_\eta^{i,j,l+1}  =& \eta|_\eta^{ijl}  + \Delta t \dtwo{F_\eta}{\eta}ij \\
    & - \frac{\Delta t}{a\cos\vartheta|_\eta^{j}\Delta\lambda}
      \Biggl(H|_u^{i+1,j} u|_u^{i+1,j,l} - H|_u^{ij}u|_u^{ijl}\Biggr) \\
    & - \frac{\Delta t}{a\cos\vartheta|_\eta^{j}\Delta\vartheta}  
      \Biggl(H|_v^{i,j+1}\cos\vartheta|_v^{j+1}v|_v^{i,j+1,l} - H|_v^{ij}\cos\vartheta|_v^{j}v|_v^{ijl}\Biggr)
  \end{split}
\end{equation}
\begin{equation}
  u|_u^{i,j,l+1} = u|_u^{ijl} 
    + \Delta t f v|_u^{ijl}
    - \frac{\Delta t g}{a\cos\vartheta|_u^j\Delta\lambda}
      \Biggl(\eta|_\eta^{i,j,l+1} - \eta|_\eta^{i-1,j,l+1}\Biggr) + \Delta t \dtwo{F_u}uij
\end{equation}
\begin{equation}
  v|_v^{i,j,l+1} = v|_v^{ijl} 
    - \Delta t f u|_v^{i,j,l+1} 
    - \frac{\Delta t g}{a\Delta\vartheta}
      \Biggl(\eta|_\eta^{i,j,l+1} - \eta|_\eta^{i,j-1,l+1}\Biggr) + \Delta t \dtwo{F_v}vij
\end{equation}
In the model, we'll calculate $H|_u^{ij}$ and $H|_v^{ij}$ once in the beginning and
then use it throughout the simulation. However, for defining which grid points are 
over land, it is still helpful to use the original $H$-grid.
Note that the Rayleigh friction (linear bottom friction) and the Newtonian cooling
is discretized with an implicit scheme. 

%=======================================================================

\section{Stability}
Note that we will not consider optimization of roundoff errors at this point. We'll stick
to SI-units and readable code as long as possible.

There are two criteria which may be of importance: $|\Delta t\cdot f|<1$ which comes from the
Coriolis term, and the CFL criterion $c\frac{\Delta t}{\Delta x}=\sqrt{gH}\frac{\Delta t}{\Delta x}<1$. The CFL
criterion is by far the most dangerous. From the first criterion, $\Delta t$ varies from infinity
at the equator to half a day at the poles, while from CFL with high resolution, high latitudes and 
large $H$ time steps of much less than $10$ seconds can easily arise.
\begin{equation}
  \Delta t < \frac{\Delta\lambda/deg \cdot 111km \cdot \cos\vartheta^{max}}{\sqrt{gH}} 
\end{equation}
For $H=O(10km)$, $\Delta\lambda=1/10^{o}$ and a model domain which extends up to $89N$, this results in 
as short a time steps as $0.6$ seconds.

%=======================================================================

\section{Estimation of computational effort}
In the end, we might want to simulate an almost global model
(say $\lambda=0\ldots360^\circ$, $\vartheta=-89\ldots89^\circ$) with a resolution 
of up to $1/10^\circ$ for more than one year of model time. There are 
$360*178*100\approx 6.5\cdot10^6$ grid points and for each grid point we need $O(20)$ 
multiplications and additions. The time step is $\approx 0.6s$ and one year of model time
has $\approx 3.15\cdot 10^7s$. Altogether, we need $N\approx 6.7\cdot 10^{15}$ operations which
on a machine with $8GFLOPS$ can be done in $8.5\cdot 10^5s\approx 10d$. For a smaller domain, which
only extends to $85^\circ$ in latitude, only about $2d$ are necessary.

%=======================================================================

\section{First test: Rectangular domain}
Domain:
\begin{equation}
  \begin{split}
    \lambda & = -20^\circ \ldots 20^\circ \\
    \vartheta & = -20^\circ \ldots 20^\circ \\
    \Delta \lambda & = \Delta \vartheta = 0.4^\circ \\
    H & = 1000m = const. \\
    \Rightarrow \Delta t & = 422 s \\
  \end{split}
\end{equation}

Initial conditions:
Adjustment should be done after $O(20 \cdot 2 \cdot 111km / \sqrt{gH}) = 
O(4.5\cdot 10^4s) = O(100) \Delta t$.

%=======================================================================

%\bibliographystyle{plainnat}
%\bibliography{bibliography}

\end{document}
